name: "Python reusable Workflow"

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version required"
        required: true
        type: string
        default: "3.12"
      build-tool:
        description: "Choose the build tool: pip, poetry, uv or pipenv"
        required: true
        type: string
        default: "pip"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ inputs.python-version }}

      - name: Validate inputs
        run: |
          echo "Validating inputs..."
          case "${{ inputs.build-tool }}" in
            pip|poetry|pipenv|uv) echo "Valid build tool: ${{ inputs.build-tool }}" ;;
            *) echo "Unsupported build tool: ${{ inputs.build-tool }}" && exit 1 ;;
          esac

      - name: Set up cache path
        run: |
          echo "Setting up cache files"
          case "${{ inputs.build-tool }}" in
            pip) echo "CACHE_PATH=~/.cache/pip" >> "$GITHUB_ENV" ;;
            poetry) echo "CACHE_PATH=~/.cache/pypoetry" >> "$GITHUB_ENV" ;;
            pipenv) echo "CACHE_PATH=~/.cache/pipenv" >> "$GITHUB_ENV" ;;
            uv) echo "CACHE_PATH=~/.cache/uv" >> "$GITHUB_ENV" ;;
          esac

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATH }}
          key: ${{ runner.os }}-${{ inputs.build-tool }}-${{ hashFiles('**/poetry.lock', '**/Pipfile.lock', '**/requirements.txt') }}

      - name: Install build tool
        run: |
          case "${{ inputs.build-tool }}" in
            poetry)
              curl -sSL https://install.python-poetry.org | python3 -
              echo "$HOME/.local/bin" >> $GITHUB_PATH
              ;;
            pipenv)
              pip install pipenv
              ;;
            uv)
              curl -Ls https://astral.sh/uv/install.sh | bash
              ;;
          esac

      - name: Install Dependencies
        run: |
          if [ "${{ inputs.build-tool }}" == "pip" ]; then
            if [ ! -f requirements.txt ]; then
              echo "No requirements.txt found"
              exit 1
            else
              pip install -r requirements.txt
            fi

          elif [ "${{ inputs.build-tool }}" == "poetry" ]; then
            if [ ! -f pyproject.toml ]; then
              poetry init --name "auto-generated-project" \
                          --dependency "requests" \
                          --dev-dependency "pytest" \
                          --no-interaction
            fi
            poetry install --no-root

          elif [ "${{ inputs.build-tool }}" == "pipenv" ]; then
            if [ ! -f Pipfile ]; then
              echo "No Pipfile found. Creating default with pytest"
              pipenv install --dev pytest
            else
              pipenv install
            fi

          elif [ "${{ inputs.build-tool }}" == "uv" ]; then
            if [ ! -f "requirements.txt" ]; then
              echo " requirements.txt not found"
              exit 1
            fi
            if [ ! -d "env" ] && [ ! -d ".venv" ] && [ ! -d "venv" ]; then
              echo "No virtual environment is set"
              echo "Setting then virtual environemnt"
              uv venv .venv
            fi
            uv pip install -r requirements.tx
          fi

      - name: Run tests
        run: |
          REPORT_FILE="test-results.xml"
          if [ "${{ inputs.build-tool }}" == "poetry" ]; then
            poetry run pytest --junitxml=$REPORT_FILE
          elif [ "${{ inputs.build-tool }}" == "pipenv" ]; then
            pipenv run pytest --junitxml=$REPORT_FILE
          elif [ "${{ inputs.build-tool }}" == "uv" ]; then
            .venv/bin/pytest --junitxml=$REPORT_FILE
          else
            pytest --junitxml=$REPORT_FILE
          fi

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-results.xml

      - name: Summarize test results
        run: |
          python3 <<EOF >> $GITHUB_STEP_SUMMARY
print("### ðŸ§ª Test Summary")
print("| Test File | Test Case | Result |")
print("|-----------|-----------|--------|")

import xml.etree.ElementTree as ET
tree = ET.parse("test-results.xml")
root = tree.getroot()

for testcase in root.iter("testcase"):
    classname = testcase.attrib.get("classname", "Unknown")
    name = testcase.attrib.get("name", "Unnamed")
    if testcase.find("failure") is not None:
        status = "âŒ Failed"
    elif testcase.find("error") is not None:
        status = "ðŸš¨ Error"
    else:
        status = "âœ… Passed"
    print(f"| {classname} | {name} | {status} |")
EOF

      - name: Summary Report (Success)
        if: ${{ success() }}
        run: |
          echo "### Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Success" >> $GITHUB_STEP_SUMMARY

      - name: Summary Report (Failure)
        if: ${{ failure() }}
        run: |
          echo "### Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: Failed" >> $GITHUB_STEP_SUMMARY
